---
id: "0012"
title: Premium Subscription Model Integration
status: proposed
date: 2025-10-21
---

## Context and Problem Statement

MobilityCorp plans to introduce a **Premium (Concierge) Subscription Tier** offering enhanced routing, priority support, and personalised AI-driven services.  
To operationalise this, subscriptions must be **managed, billed, and authorised** consistently across APIs and microservices.

The system must:
- Support **user enrolment**, **billing**, and **entitlement checks** at runtime.  
- Integrate with existing **identity and access management** systems.  
- Enforce access controls for premium-only features (e.g., Concierge Service, advanced analytics).  
- Expose subscription state to downstream services without introducing cross-service coupling.  
- Maintain **auditability and compliance** for billing and consent (see ADR-011).

---

## Questions

- Should subscriptions be verified on every API request or via cached session tokens?  
- How are billing events synchronised between payment gateway and internal audit ledger?  
- How do non-premium services safely degrade if subscription validation fails?  
- How will premium entitlements integrate with existing authentication flows (JWT, OAuth2)?  
- Should premium tiers be managed internally or via a third-party billing provider?

---

## Options

### Option A — External Billing & Entitlement Provider
Use a third-party SaaS (e.g., Stripe Billing, Recurly) for subscription lifecycle and entitlements.

**Pros**
- Fast implementation; mature APIs and dashboards.  
- Handles invoicing, proration, and renewals automatically.  

**Cons**
- Data residency concerns for EU customers.  
- Limited flexibility for in-app contextual entitlements.  
- Adds dependency on external vendor uptime.

---

### Option B — Internal Subscription & Entitlement Service (Recommended)
Build a dedicated **Subscription Service** that integrates with internal authentication (OAuth2/JWT) and the **Audit Log (ADR-011)** for traceability.  
Billing still uses an external payment gateway (e.g., Stripe) but all entitlements and access decisions are managed internally.

**Pros**
- Full control over entitlements, privacy, and residency.  
- Reusable across mobile, web, and partner APIs.  
- Enables fine-grained premium logic at the API gateway.  
- Seamless integration with AI Concierge (ADR-009).  

**Cons**
- Slightly higher engineering and maintenance cost.  
- Requires secure token issuance and validation flow.

---

### Option C — Monolithic Integration Within Identity Provider
Embed subscription metadata directly in the Identity Provider (IdP) tokens.

**Pros**
- Simplifies token validation at API edge.  

**Cons**
- Harder to evolve billing logic independently.  
- Token refresh required on every subscription change.  
- Tight coupling between IdP and billing domain.

---

## Recommendation

Adopt **Option B – Internal Subscription & Entitlement Service** that centralises premium user management and API-level authorisation.

**Key decisions**
1. **Dedicated Subscription Service:** owns subscription lifecycle, entitlements, and linkage to payment provider.  
2. **Auth Integration:** service issues signed JWT claims (`tier=premium`) validated by API Gateway.  
3. **Billing Integration:** payment gateway handles charge events; confirmed transactions trigger internal subscription activation.  
4. **Audit Trail:** all subscription changes published to the **Immutable Audit Log (ADR-011)**.  
5. **Event-Driven Updates:** subscription events emitted to Kafka for analytics and Databricks ingestion (ADR-007).  
6. **Degraded Mode:** non-premium users receive limited functionality gracefully.

---

## Consequences

**Positive**
- Unified control over premium entitlements and billing traceability.  
- Seamless experience between app, concierge, and billing flows.  
- Strong audit and compliance posture.  

**Trade-offs**
- Requires coordination between payment provider and internal systems.  
- Slight latency overhead for token validation and entitlement checks.  

---

## Implementation Details (High-level)

| Component | Responsibility | Notes |
|---|---|---|
| **Subscription Service** | Manage user tiers, billing status, entitlements | Owns premium logic |
| **Auth / Identity Provider** | Issue access tokens with subscription claims | Integrates via OAuth2/JWT |
| **Payment Gateway (Stripe)** | Process payments and renewals | Emits webhook events |
| **API Gateway** | Validate JWT tier claims; route to premium endpoints | Deny or downgrade on invalid tier |
| **Kafka / Event Bus** | Broadcast subscription events | Shared ingestion layer (ADR-007) |
| **Databricks Lakehouse** | Store analytics and billing metrics | EU-resident warehouse |
| **Audit Log (ADR-011)** | Immutable record of subscription actions | Hash-chained verification |
| **Mobile / Web App** | Display premium status and upsell prompts | Refreshes entitlements post-payment |

**Sequence Example**
```mermaid
sequenceDiagram
    %% Premium Subscription Activation Flow
    participant APP as User App
    participant PAY as Payment Gateway
    participant SUB as Subscription Service
    participant AUTH as Identity Provider
    participant GWAY as API Gateway
    participant KAF as Kafka (Event Bus)
    participant AUD as Audit Log

    APP->>PAY: Initiate premium subscription payment
    PAY-->>SUB: Send payment confirmation webhook
    SUB->>SUB: Create subscription record (tier=premium)
    SUB->>AUTH: Update user claims / issue new JWT
    SUB->>AUD: Log subscription activation
    SUB->>KAF: Publish subscription event
    APP->>GWAY: Access premium endpoint with new token
    GWAY->>AUTH: Validate JWT & tier claim
    GWAY-->>APP: Grant access to premium features
