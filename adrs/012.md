---
id: "0012"
title: Premium Subscription Model Integration
status: proposed
date: 2025-10-22
---

## Context and Problem Statement

MobilityCorp offers **premium subscription tiers** that unlock advanced capabilities such as:
- Concierge personalisation (ADR-009)  
- Priority routing and dynamic rebalancing (ADR-005)  
- Detailed analytics and extended history for fleet managers  

Currently, entitlement checks and billing logic are dispersed across systems.  
To enable **region-aware pricing**, **centralised governance**, and **AI-driven service differentiation**, these must be unified under a consistent backend model.

---

## Questions

- How are user subscriptions, tiers, and entitlements stored and validated across services?  
- How do we handle regional currency and taxation differences?  
- How do backend AI services (Interchange, Concierge, Routing) validate tier access in real time?  
- How are billing events and consent managed under GDPR and EU consumer law?  
- Should policy data (pricing, grace periods, entitlements) be static or versioned (ADR-019)?

---

## Options

### Option A — Decentralised Entitlement Checks
Each service manages its own subscription logic.

**Pros**
- No central dependency.  
**Cons**
- Inconsistent enforcement; duplicated code; poor auditability.

---

### Option B — Centralised Billing Gateway Only
Single billing API manages payments, but entitlements checked downstream.

**Pros**
- Simplifies payment reconciliation.  
**Cons**
- Still fragmented for feature gating and policy evolution.

---

### Option C — Unified Premium Subscription Framework (Recommended)
Introduce a **central Subscription Service** that integrates with:
- **Policy-as-Data (ADR-019)** for pricing, region, and entitlement rules.  
- **AI Interchange (ADR-014)** and **Concierge (ADR-009)** for runtime enforcement.  
- **Audit Log (ADR-011)** for event traceability.  

**Pros**
- Consistent, auditable, region-aware access control.  
- Enables rapid policy updates without code changes.  
**Cons**
- Slightly increased latency for tier checks.  

---

## Recommendation

Adopt **Option C – Unified Premium Subscription Framework**.

**Key design decisions**
1. **Subscription Service:** central microservice managing users’ subscription states, tiers, and grace periods.  
2. **Policy-as-Data Integration:** subscription rules (pricing, trials, limits) stored as versioned data (ADR-019).  
3. **Regional Localisation:** pricing in local currency; tax rules by region; locale-aware comms.  
4. **Real-Time Validation:** AI Interchange (ADR-014) queries the service for user tier before invoking premium models.  
5. **Billing Gateway:** integrates with external payment providers (e.g., Adyen, Stripe) and emits billing events.  
6. **Audit Logging:** every subscription change (create, renew, cancel) recorded immutably (ADR-011).  
7. **GDPR Compliance:** explicit consent for premium data use and automated decisioning (ADR-017).  

---

## Consequences

**Positive**
- Unified control of entitlements and policy logic.  
- Regionally compliant pricing and tax handling.  
- Seamless integration with AI and concierge services.  

**Trade-offs**
- Added dependency in AI request flow.  
- Requires synchronisation between billing and policy data.

---

## Implementation Details (High-level)

| Component | Responsibility | Notes |
|---|---|---|
| **Subscription Service** | Manage user tiers, billing status, and entitlements | Central source of truth |
| **Billing Gateway** | Handle payment providers and invoices | Stripe / Adyen integration |
| **Policy-as-Data (ADR-019)** | Store pricing and entitlements per region | Versioned, queryable |
| **AI Interchange (ADR-014)** | Validate tier before premium inference | Real-time check |
| **Concierge Service (ADR-009)** | Offer premium recommendations | Context-aware personalisation |
| **Audit Log (ADR-011)** | Record subscription lifecycle events | Tamper-evident ledger |
| **Governance Layer (ADR-017)** | Manage consent and explainability | GDPR Art. 22 compliance |
| **Observability (ADR-013)** | Track latency, billing errors, churn | Unified OTel metrics |

**Sequence Example**

<img width="3724" height="1170" alt="012" src="https://github.com/user-attachments/assets/7fba868d-d43a-48dc-a58b-43114215b6b0" />

---

## Risks and Mitigations

| Risk                       | Likelihood | Impact | Mitigation                         |
| -------------------------- | ---------: | -----: | ---------------------------------- |
| Billing API outage         |        Med |   High | Retry queue + grace period         |
| Policy drift               |        Med |    Med | Policy-as-Data versioning          |
| Latency in AI requests     |        Low |    Med | Cached entitlements with TTL       |
| GDPR non-compliance        |        Low |   High | Explicit consent and deletion APIs |
| Currency conversion errors |        Med |    Med | Use regional gateway configuration |

---

## Alternatives Considered

* Decentralised checks – rejected for audit and governance gaps.
* Billing-only gateway – rejected for fragmented entitlement logic.
* Unified subscription service – chosen for consistency, compliance, and policy agility.

## Links

* ADR-007 – Data Platform Architecture
* ADR-009 – Concierge / Personalisation Service Architecture
* ADR-011 – Immutable Audit Log Architecture
* ADR-013 – Observability & Metrics Standardisation
* ADR-014 – AI Interchange Layer Architecture
* ADR-017 – AI Governance & Explainability Framework
* ADR-018 – AI Cost & Budget Guardrails
* ADR-019 – Policy-as-Data Framework
