---
id: "0016"
title: AI Data Pipeline & Feature Store Design
status: proposed
date: 2025-10-22
---

## Context and Problem Statement

MobilityCorp’s AI systems—**Routing Solver (ADR-005)**, **Demand Prediction (ADR-004)**, and **Concierge Service (ADR-009)**—all rely on a consistent, explainable, and region-aware foundation of **features** derived from operational telemetry, transport data, and weather conditions.

The AI Data Pipeline must support:

- **Multi-region ingestion** (localised transport and traffic feeds).  
- **Weather-aware features** (temperature, precipitation, strikes).  
- **Cross-model reuse** (routing, prediction, personalisation).  
- **Full lineage and audit compliance** (ADR-011).  

---

## Questions

- How can regional transport and weather events be unified into shared feature definitions?  
- How do we guarantee schema consistency across routing, prediction, and concierge models?  
- Should features be refreshed continuously (streaming) or in batches?  
- How do we ensure reproducibility for retraining and regulatory audits?  

---

## Options

### Option A — Independent Pipelines Per Model
Each AI model defines its own data pipeline and feature extraction.

**Pros**
- Decentralised flexibility.  
**Cons**
- Redundant logic, inconsistent schemas, poor reproducibility.  

---

### Option B — Central Feature Store with Batch-Only Refresh
Single store populated nightly from data warehouse.

**Pros**
- Central control and versioning.  
**Cons**
- Stale data for real-time inference.  
- Incompatible with dynamic routing or concierge recommendations.  

---

### Option C — Unified Real-Time + Batch Feature Store (Recommended)
Use **Kafka** + **Databricks Delta Lake** to generate and serve consistent feature sets for all AI models, combining real-time (weather, transport, demand) and offline (historical) data.

**Pros**
- Reusable across models (Routing, Prediction, Concierge).  
- Region- and weather-aware features.  
- Fully auditable and reproducible.  
**Cons**
- Requires strong governance and metadata management.  

---

## Recommendation

Adopt **Option C – Unified Real-Time + Batch Feature Store** integrated with the **Data Platform (ADR-007)** and serving both **training** and **inference**.

**Key decisions**
1. **Multi-Source Ingestion:** Transport, weather, telemetry, and demand events from Kafka (ADR-007).  
2. **Transformation Pipelines:** Databricks Structured Streaming aggregates, enriches, and validates features.  
3. **Feature Registry:** central metadata catalog with freshness, version, and region scope (`region_code`).  
4. **Offline Store (Delta Lake):** batch features for model training and validation.  
5. **Online Store (Redis/API):** live features for inference used by AI Interchange (ADR-014).  
6. **Feature Groups:**  
   - `routing_features` → ETA, congestion, depot capacity.  
   - `demand_features` → past usage, holidays, weather, strike indicators.  
   - `concierge_features` → personalised context, user-tier, environmental conditions.  
7. **Lineage & Audit:** full feature lineage logged to ADR-011.  
8. **Observability:** freshness, drift, and latency metrics to ADR-013.

---

## Consequences

**Positive**
- Reproducible, auditable AI features shared across models.  
- Real-time updates enable adaptive routing and recommendations.  
- Regional scalability with unified governance.  

**Trade-offs**
- Higher complexity in orchestration and metadata maintenance.  
- Requires coordinated feature versioning across teams.

---

## Implementation Details (High-level)

| Component | Responsibility | Notes |
|---|---|---|
| **Kafka / Event Bus** | Ingest telemetry, transport, weather, demand events | EU-resident cluster |
| **Databricks Pipelines** | Clean, transform, and aggregate features | Structured Streaming + Delta |
| **Feature Registry** | Store schema, version, freshness, owner | Delta table + metastore |
| **Offline Store (Delta Lake)** | Historical features for training | Supports reproducible snapshots |
| **Online Store (Redis/API)** | Real-time feature lookup for inference | Cached by region and model type |
| **Audit Log (ADR-011)** | Immutable feature lineage | Tamper-evident ledger |
| **Observability (ADR-013)** | Monitor feature latency, drift, and refresh | OTel-compliant metrics |
| **AI Interchange (ADR-014)** | Request real-time features by region/model | Shared interface across services |
| **Model Hosting (ADR-015)** | Consume offline features for training jobs | SageMaker EU region |
| **Concierge Service (ADR-009)** | Subscribe to feature updates and demand forecasts | Powers personalised advice |

**Sequence Example**

<img width="5037" height="1170" alt="16" src="https://github.com/user-attachments/assets/df19d35f-2fa2-48ec-ba94-77208cca694c" />

---

## Risks and Mitigations

| Risk                             | Likelihood | Impact | Mitigation                                 |
| -------------------------------- | ---------: | -----: | ------------------------------------------ |
| Provider data inconsistencies    |        Med |   High | Schema validation and registry enforcement |
| Weather API downtime             |        Low |    Med | Caching and fallback                       |
| Region misalignment              |        Med |    Med | Features keyed by `region_code`            |
| Feature drift or stale updates   |        Med |   High | Drift detection and freshness alerts       |
| Cross-model dependency conflicts |        Med |    Med | Governance board + CI feature validation   |

---

## Alternatives Considered

* Per-model pipelines – rejected for duplication and inconsistency.
* Batch-only feature store – rejected for latency and stale context.
* Unified real-time + batch store – chosen for scalability, reproducibility, and cross-model reuse.

## Links

* ADR-004 – Demand Prediction Model
* ADR-005 – Routing Solver (VRP-TW)
* ADR-007 – Data Platform Architecture
* ADR-009 – Concierge / Personalisation Service Architecture
* ADR-011 – Immutable Audit Log Architecture
* ADR-013 – Observability & Metrics Standardisation
* ADR-014 – AI Interchange Layer Architecture
* ADR-015 – Model Hosting & Inference Strategy
