---
id: "0005"
title: Routing Solver (VRP-TW)
status: proposed
date: 2025-10-22
---

## Context and Problem Statement

MobilityCorp coordinates field operations across multiple European cities â€” dispatching vehicles, battery-swap teams, and collection crews.  
Accurate and efficient **route optimisation** is essential to meet SLAs and reduce operational cost.

Earlier versions of the routing logic relied on **UK-specific (TfL)** feeds and static traffic data.  
With expansion across Europe, the system must now:

- Support **localised transport data providers** (RATP ðŸ‡«ðŸ‡·, BVG ðŸ‡©ðŸ‡ª, ATAC ðŸ‡®ðŸ‡¹, etc.).  
- Incorporate **weather and demand forecasts** to adjust routing dynamically.  
- Remain compliant with EU data-residency and observability standards.  

---

## Questions

- How do we normalise multiple regional transport APIs into a single routing context?  
- Should the solver consume weather and demand data as static inputs or live event streams?  
- How can we ensure low-latency re-optimisation during network disruptions or strikes?  
- How are routing outcomes audited and measured against SLA targets?  

---

## Options

### Option A â€” External Routing API Only
Use a third-party routing API (Google, HERE, Mapbox).

**Pros**
- Minimal infrastructure; built-in traffic updates.  
**Cons**
- Limited control, opaque constraints, non-EU data handling, unpredictable cost.

---

### Option B â€” Internal Solver Without External Context
Run an in-house VRP-TW solver using static maps and telemetry.

**Pros**
- Full control of logic and data residency.  
**Cons**
- Ignores dynamic traffic, weather, or demand variation.  
- Poor adaptability in live operations.

---

### Option C â€” Context-Aware Internal Solver (Recommended)
Integrate a **VRP-TW solver** with **regional transport adapters**, **weather inputs**, and **demand forecasts**.

**Pros**
- Region-local accuracy and compliance.  
- Adaptive routing under real-world conditions.  
- Compatible with MobilityCorpâ€™s event-driven backend (ADR-007).  
**Cons**
- Higher integration complexity.  
- Requires feature engineering and model retraining for ETA calibration.

---

## Recommendation

Adopt **Option C â€“ Context-Aware Internal VRP-TW Solver**.

**Key decisions**
1. **Transport Adapter Layer** normalises regional feeds (GTFS-RT or proprietary) into a unified event schema (`route_id`, `delay`, `region_code`).  
2. **Weather Feed Integration:** weight travel times by live precipitation, temperature, and wind factors.  
3. **Demand Prediction Link:** solver subscribes to `demand.predictions` topic to prioritise hubs with projected shortages.  
4. **Kafka Topics:**  
   - Inputs â†’ `routing.requests`, `transport.status`, `weather.conditions`, `demand.predictions`.  
   - Outputs â†’ `routing.solved`, `routing.metrics`.  
5. **Solver Engine:** OR-Tools or custom heuristic supporting multi-depot, capacity, and time-window constraints.  
6. **Audit & Metrics:** every solve logged (inputs + hash) to **ADR-011** and metrics exported via **ADR-013**.

---

## Consequences

**Positive**
- Region- and weather-aware routing with proactive demand balancing.  
- Reduced missed appointments and travel time.  
- Auditable, EU-resident optimisation workflow.  

**Trade-offs**
- Higher engineering and data-integration overhead.  
- Ongoing maintenance of provider connectors and model tuning.

---

## Implementation Details (High-level)

| Component | Responsibility | Notes |
|---|---|---|
| **Transport Adapter** | Normalise regional transport feeds | Connectors per country; publishes to Kafka |
| **Weather Collector** | Fetch and broadcast weather data | Hourly updates from OpenWeatherMap / MeteoGroup |
| **Demand Predictor (ADR-004)** | Publish demand forecast events | Feeds solver for hub prioritisation |
| **Routing Solver** | Compute optimal VRP-TW routes | Context-aware heuristics |
| **Kafka Event Bus** | Carry input/output events | EU-resident cluster |
| **Databricks Lakehouse** | Persist solved routes & metrics | For analytics and retraining |
| **Audit Log (ADR-011)** | Immutable route decision record | Hash-chained ledger |
| **Observability (ADR-013)** | Track latency, success rate, solver cost | OTel metrics |

**Sequence Example**

---

## Risks and Mitigations

| Risk                           | Likelihood | Impact | Mitigation                            |
| ------------------------------ | ---------: | -----: | ------------------------------------- |
| Provider API schema drift      |        Med |   High | Schema registry + contract tests      |
| Weather API latency            |        Low |    Med | Cache & extrapolate short gaps        |
| Incorrect demand bias          |        Med |    Med | Periodic model validation             |
| Region data inconsistency      |        Med |    Med | Region-code governance & monitoring   |
| Solver performance degradation |        Med |    Med | Heuristic tuning & parallel execution |

## Alternatives Considered

* Third-party API only â€“ rejected for cost/compliance.
* Static internal solver â€“ rejected for lack of context awareness.
* Context-aware solver â€“ chosen for adaptability and EU governance alignment.

##Â Links

* ADR-004 â€“ Demand Prediction Model
* ADR-007 â€“ Data Platform Architecture
* ADR-011 â€“ Immutable Audit Log Architecture
* ADR-013 â€“ Observability & Metrics Standardisation
* ADR-016 â€“ AI Data Pipeline & Feature Store Design
* ADR-018 â€“ AI Cost & Budget Guardrails