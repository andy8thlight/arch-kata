---
id: "0005"
title: Routing Solver (VRP-TW)
status: proposed
date: 2025-10-18
---

## Context and Problem Statement

MobilityCorp must **generate and continuously optimise field-operative routes** for:
- **Battery swap missions** (low-charge vehicles)
- **Re-balancing** (moving vehicles between hubs)
- **Maintenance and recovery** (broken or misplaced vehicles)

Operational goals:
- Cover all high-priority tasks within available **shift windows**
- Minimise total travel time, energy cost, and missed SLAs
- Respect constraints: **vehicle capacity**, **technician availability**, **traffic**, **hub time windows**, **depot start/end**
- Support **re-optimisation** as forecasts or constraints change (surge, weather, cancellations, hub capacity changes)

### Questions
- Centralised routing per city/region, or distributed per depot?
- What optimisation approach balances **performance, cost, and explainability**?
- How do we incorporate **AI demand forecasts** (ADR-0004) and hub capacity predictions?
- How do we enable **re-optimisation** without creating task churn for operators?
- What interfaces do Field-Ops and Back Office need for transparency and overrides?

---

## Options

### Option A — Heuristic rules (greedy nearest-neighbour)
**Pros:** simple, cheap, explainable  
**Cons:** sub-optimal for multi-stop/multi-vehicle; weak with time windows; brittle under dynamics

### Option B — Full **VRP-TW** solver using **OR-Tools** (**Recommended**)
Compute multi-vehicle, time-windowed routes with soft constraints and event-driven re-optimisation.  
**Pros:** mature, cost-efficient, deterministic, explainable, EU self-hosted; supports capacities & time windows  
**Cons:** constraint/penalty tuning required; CPU-intensive at city scale (needs partitioning); deterministic (no learned heuristics)

### Option C — ML-assisted routing (RL / predictive assignment)
**Pros:** potentially faster, can encode learned preferences  
**Cons:** higher complexity/cost; weaker explainability; requires large labelled history

### Option D — Third-party optimisation API
**Pros:** minimal setup, vendor SLAs  
**Cons:** cost scales with usage; GDPR/data-residency concerns; vendor lock-in; limited custom constraints

---

## Decision

Adopt **Option B: OR-Tools-based VRP-TW solver** as a dedicated internal microservice.

- **Routing Service** ingests task pools (battery swaps, rebalancing, maintenance) and **resource constraints** (shifts, depots, vehicle capacity).
- Incorporates **demand forecasts** (ADR-0004) to prioritise tasks and pre-positioning, and **hub-slot reservation** (ADR-0012) for valid destinations.
- Supports **re-optimisation triggers**:
  - **Scheduled** (e.g., every 30–60 min; at shift start/end)
  - **Event-driven** (forecast delta threshold, task changes, hub capacity update, severe weather)
  - **Manual** (Back Office “re-solve” with overrides)
- Exposes REST + async interfaces for **Field-Ops App** (task queue) and **Back Office** (monitoring, approve/lock plans).
- Logs every solution (inputs, seed, objective, constraints, plan) to **Audit Log** (ADR-0013) and **Data Platform** (ADR-0009).

> **AI-assist (optional, phased):** enable an **ML re-ranking module** to reorder solver-tied solutions (choose best among k-opt neighbourhoods) when measurable lift ≥ X% and within cost guardrails (ADR-0020). The deterministic solver stays the source of truth.

---

## Consequences

**Positive**
- Deterministic, explainable routing aligned to enterprise operations and compliance
- Integrates forecasts and hub availability for proactive pre-positioning
- EU-resident, no SaaS lock-in; predictable cost envelope
- Clear operator UX via planned dispatch + controlled re-opt cadence

**Trade-offs**
- Compute cost spikes during large re-solves; requires batching/partitioning
- Constraint modeling & penalty tuning is non-trivial
- Must prevent **task churn** (operator context switching) via guardrails

---

## Implementation Details (High-level)

| Component | Responsibility |
|---|---|
| **Routing Service (VRP-TW)** | `/solve`, `/reschedule`, `/what-if`; runs OR-Tools with soft/hard constraints; emits `route_plan` events |
| **AI Interchange Layer** | Supplies demand forecasts, receives plans; optional re-ranking; cost & drift monitoring |
| **Field-Ops App** | Receives plans, shows stop order, collects progress/proof; offline-first |
| **Back Office** | Monitors KPIs (utilisation, SLA, distance), locks plans, applies overrides, triggers re-solve |
| **Data Platform** | Stores tasks, solutions, telemetry, outcomes for benchmarking and learning |

**Inputs**
- Forecasts per hub/time (ADR-0004); hub capacity & slots (ADR-0012)  
- Task pool (low-battery, maintenance, recovery) with priorities & service times  
- Resources (operatives, vans, depots, shift windows, capacities)  
- Travel-time matrix (cached from external maps API), traffic profile  
- Policy constraints (max route duration, lunch breaks, zone restrictions)

**Outputs**
- Ordered stop lists per operative with ETA/ETD, distance, service time  
- KPIs: total time/distance, service-level coverage, late/early penalties  
- Confidence/quality metrics; plan version id; reproducible seed  
- Events: `route_plan.created`, `route_plan.updated`, `route_task.progress`, `route_task.completed`

---

## Sequence

```mermaid
sequenceDiagram
    title Routing Solver (VRP-TW) – End-to-End Flow

    participant AI as AI Interchange Layer
    participant DP as Data Platform / Feature Store
    participant PM as Prediction Service (Demand Forecast)
    participant RS as Routing Service (VRP-TW Solver)
    participant FO as Field-Ops App
    participant BO as Back Office

    %% Step 1 – Forecasts and triggers
    PM-->>AI: Publish forecast {hub_id, horizon, demand_curve}
    AI-->>RS: Trigger routing cycle (scheduled / delta / manual)
    RS-->>DP: Fetch task pool (swaps, rebalancing, maintenance)
    RS-->>DP: Fetch travel-time matrix (cached maps API)
    RS-->>AI: Get resource & policy constraints (shifts, depots, caps)

    %% Step 2 – Optimisation
    RS->RS: Solve VRP-TW (multi-vehicle, time windows, capacities)
    RS-->>AI: route_plan {route_id, tasks, ETA, metrics}
    alt Optional AI re-ranking
      AI->AI: Re-rank candidate plans (if lift ≥ threshold)
    end

    %% Step 3 – Dispatch and execution
    AI-->>FO: Push assigned route & tasks
    FO-->>RS: ACK route receipt / progress updates
    FO-->>AI: Task status (completed, delayed, skipped)

    %% Step 4 – Monitoring and re-optimisation
    AI-->>BO: KPIs dashboard (utilisation, SLA, distance)
    BO-->>AI: Overrides / lock plan / trigger partial re-solve
    AI-->>RS: Re-trigger (delta solve on affected zones)

    %% Step 5 – Feedback loop
    FO-->>DP: Completion data, service times
    DP-->>PM: Actuals → retraining & performance metrics
    PM-->>AI: Forecast accuracy score; drift alerts

---

### Guardrails (Operator Experience)

* Stability window: minimum X minutes between re-plans unless critical events
* Freeze threshold: do not re-assign tasks in progress or inside Y-minute start window
* Change budget: cap at Z% of tasks changed per re-plan to limit churn
* Explainability: UI shows why a plan changed (surge, outage, hub capacity, weather)

### Risks and Mitigations

| Risk | Likelihood | Impact | Mitigation |
| ---- | ---------- | ------ | ---------- |
| High CPU cost for large fleets | Med | Med–High | Partition by region/city; cap solve time; incremental/delta solves; off-peak pre-solves |
| Task churn from frequent re-solves |	Med | High | Stability window; freeze rules; change budget; operator approval for major updates |
| Poor data quality (stale forecasts/traffic) |	Med | Med |	Confidence scores; fallback to last plan; alert on stale inputs |
| Infeasible constraints (solver fails) | Low–Med |	Med | Soft constraints with penalties; feasibility relaxations; operator prompts |
| External maps API latency/rate limits	| Med |	Med | Cache matrices; precompute frequent pairs; retry/backoff; secondary provider |
| Integration failures (event bus/API) | Low–Med | Med | Idempotent events; retries & DLQ (ADR-0002); reconciliation jobs |
| Over-optimisation vs real ops reality | Med |	Med | Calibrate with empirical service times; compare planned vs actual; continuous tuning |
| Optional AI re-ranking opacity | Low | Med | Keep solver authoritative; log re-rank rationale; feature-flag with A/B metrics |


### Alternatives Considered

* RL / ML routing first: deferred; adopt only if measurable lift and acceptable explainability
* Third-party SaaS: deferred due to GDPR, cost volatility, and custom constraints
* Heuristics-only: rejected due to scale and time-window requirements

### Links
ADR-0002 – External Dependency SLA & Retry Handling
ADR-0004 – Demand Prediction Model Design
ADR-0012 – Routing & Hub-slot Reservation Integration
ADR-0009 – Data Platform Architecture
ADR-0013 – Immutable Audit Log Architecture
ADR-0016 – AI Interchange Layer
ADR-0020 – AI Cost & Budget Guardrails