---
id: "0005"
title: Routing Solver (VRP-TW)
status: proposed
date: 2025-10-18
---

## Context and Problem Statement

MobilityCorp must **generate and continuously optimise field-operative routes** for:

- **Battery swap missions** (low-charge vehicles).  
- **Re-balancing** (moving vehicles between hubs).  
- **Maintenance and recovery** (broken or misplaced vehicles).  

Operational goals:
- Cover all high-priority tasks within available shift windows.  
- Minimise total travel time, energy cost, and missed SLAs.  
- Respect constraints: vehicle capacity, technician availability, traffic, and hub time windows.  
- Support **re-optimisation** as forecasts or constraints change (e.g., sudden surge, weather event).

### Questions

- Should routing be solved centrally or distributed per region?  
- What optimisation algorithm balances performance, cost, and explainability?  
- How do we incorporate **AI demand forecasts** (ADR-004) as dynamic inputs?  
- How do we enable **re-optimisation** without destabilising operator workflows?  
- What interfaces do Field-Ops and Back Office need for transparency and overrides?

---

## Options

### Option A — Heuristic rules (greedy nearest-neighbour)
Simplest approach: assign tasks based on proximity and availability using deterministic rules.

**Pros**
- Very cheap and explainable.  
- Easy to implement and debug.  

**Cons**
- Sub-optimal routing for multi-stop, multi-vehicle cases.  
- Does not scale well to dynamic inputs.  
- No awareness of time windows or global constraints.

---

### Option B — Full **VRP-TW (Vehicle Routing Problem with Time Windows)** solver using OR-Tools (Recommended)
Use an open-source solver such as **Google OR-Tools** to compute multi-vehicle, time-windowed routes with soft constraints and re-optimisation triggers.

**Pros**
- Mature, cost-efficient solver with open source license.  
- Handles time windows, capacities, priorities, and penalties.  
- Deterministic, explainable, reproducible results.  
- Runs locally (no SaaS lock-in).  

**Cons**
- Requires careful constraint tuning.  
- CPU-intensive for very large fleets (may require batching).  
- Not probabilistic — may miss rare edge optimisations.

---

### Option C — ML-assisted routing (RL / predictive assignment)
Train an ML model to propose near-optimal routes based on historical optimisation outcomes.

**Pros**
- Potentially faster inference at scale.  
- Learns implicit constraints and operator preferences.  

**Cons**
- High complexity and compute cost.  
- Harder to explain; risks regulatory friction if opaque.  
- Requires large historical dataset and tuning.

---

### Option D — Third-party optimisation API
Use an external routing SaaS (e.g., Routific, OptimoRoute).

**Pros**
- Minimal setup; outsourced complexity.  
- SLAs and support provided by vendor.  

**Cons**
- Cost scales with usage; data residency and GDPR concerns.  
- Vendor dependency; limited fine-tuning.  
- Harder to integrate re-optimisation triggers and internal constraints.

---

## Decision

Adopt **Option B: OR-Tools-based VRP-TW solver** hosted as a dedicated internal microservice:  
- **Routing Service** ingests tasks from Demand Forecasting (ADR-004) and IoT feeds (low-battery or maintenance flags).  
- Computes optimal multi-vehicle, time-windowed routes with configurable constraints (shift duration, depot start/end, vehicle capacity).  
- Exposes REST and message-based interfaces to the **Field-Ops App** (task queue) and **Back Office Dashboard** (monitoring and overrides).  
- Supports **re-optimisation triggers** on schedule (e.g., hourly) or events (forecast delta, weather, cancellations).  
- Logs every solution with metadata and metrics to **Audit Log** (ADR-013) for traceability.

---

## Consequences

**Positive**
- Efficient, deterministic routing that adapts to changing demand forecasts.  
- Explainable output: each assignment is reproducible with the same seed and input data.  
- No dependency on external SaaS; fully EU-hosted.  
- Compatible with existing Field-Ops tooling via API/websocket.  

**Trade-offs**
- Increased compute load during re-optimisations; may need batch partitioning or regional workers.  
- Requires careful configuration of time-window penalties and priorities.  
- Operators must manage re-optimisation cadence to avoid task churn.

---

## Implementation Details (High-level)

| Component | Responsibility |
|------------|----------------|
| **Routing Service (VRP-TW)** | Compute optimal assignments; expose `/solve` and `/reschedule` endpoints. |
| **AI Interchange Layer** | Supplies demand forecasts and event triggers; receives results and pushes to apps. |
| **Field-Ops App** | Consumes assigned tasks; updates progress/completion. |
| **Data Platform** | Logs historical solutions and performance metrics for retraining/benchmarking. |
| **Back Office** | Monitors KPIs (utilisation, travel time, service level) and approves manual overrides. |

**Inputs**
- Predicted demand (`forecast[horizon]`, ADR-004).  
- Hub locations and capacities.  
- Task pool (battery swaps, recoveries).  
- Resource availability (vehicles, shifts).  
- Traffic/travel-time matrix (external API).  

**Outputs**
- Ordered stop lists per operative.  
- Estimated time/cost per route.  
- Confidence and KPI metrics.  
- `route_plan` events published to Field-Ops and Data Platform.

sequenceDiagram
    title Routing Solver (VRP-TW) – End-to-End Flow

    participant AI as AI Interchange Layer
    participant DP as Data Platform / Feature Store
    participant PM as Prediction Service (Demand Forecast)
    participant RS as Routing Service (VRP-TW Solver)
    participant FO as Field-Ops App
    participant BO as Back Office

    %% Step 1 – Forecasts and triggers
    PM-->>AI: Publish forecast {hub_id, horizon, demand_curve}
    AI-->>RS: Trigger routing cycle (scheduled or forecast delta)
    RS-->>DP: Request task pool (battery swaps, rebalancing, maintenance)
    RS-->>DP: Fetch travel-time matrix (from cached external API)
    RS-->>AI: Fetch resource constraints (vehicle capacity, shifts, depots)

    %% Step 2 – Optimisation
    RS->RS: Solve VRP-TW (multi-vehicle, time-windowed optimisation)
    RS-->>AI: Publish route_plan event {route_id, tasks, ETA, metrics}

    %% Step 3 – Dispatch and execution
    AI-->>FO: Push assigned route and task list
    FO-->>RS: ACK route receipt / progress updates
    FO-->>AI: Report live task status (completed, delayed, skipped)

    %% Step 4 – Monitoring and re-optimisation
    AI-->>BO: Update dashboard KPIs (utilisation, travel time, SLA)
    BO-->>AI: Adjust constraints (shift change, priority override)
    AI-->>RS: Re-trigger partial re-optimisation (delta solve)

    %% Step 5 – Feedback loop
    FO-->>DP: Send completion data, battery usage, timing
    DP-->>PM: Feed actuals for model retraining and performance metrics
    PM-->>AI: Update accuracy score; notify Ops if drift detected

---

## Risks and Mitigations

| Risk | Mitigation |
|------|-------------|
| High CPU cost for large fleets | Batch by region or vehicle type; enforce solve
