---
id: "0005"
title: Routing Solver (VRP-TW)
status: proposed
date: 2025-10-22
---


## Context and Problem Statement

MobilityCorp, as a multi-region ride sharing and fleet operations platform, must coordinate field operations across multiple European citiesâ€”dispatching vehicles, battery-swap teams, and collection crews. Accurate and efficient **route optimisation** is essential to meet SLAs, reduce operational cost, and ensure high service quality.


Earlier versions of the routing logic relied on UK-specific (TfL) feeds and static traffic data. With MobilityCorpâ€™s expansion across Europe, the routing system must now:
- Support **localised transport data providers** (RATP ðŸ‡«ðŸ‡·, BVG ðŸ‡©ðŸ‡ª, ATAC ðŸ‡®ðŸ‡¹, etc.).
- Incorporate **weather and demand forecasts** (see [ADR-004](./004.md)) to adjust routing dynamically.
- Remain compliant with EU data-residency, auditability (see [ADR-011](./011.md)), and observability (see [ADR-013](./013.md)) standards.

This ADR builds on the event-driven, reliable integration patterns established in [ADR-001](./001.md) and [ADR-002](./002.md), ensuring that routing decisions are robust, auditable, and seamlessly integrated with upstream and downstream operational systems.

---


### Key Questions

- How do we normalise multiple regional transport APIs into a single routing context?
- Should the solver consume weather and demand data as static inputs or live event streams?
- How can we ensure low-latency re-optimisation during network disruptions or strikes?
- How are routing outcomes audited and measured against SLA targets?

---


## Options

### Option A â€” External Routing API Only
Use a third-party routing API (Google, HERE, Mapbox).

**Pros**
- Minimal infrastructure; built-in traffic updates.

**Cons**
- Limited control, opaque constraints, non-EU data handling, unpredictable cost.

---

### Option B â€” Internal Solver Without External Context
Run an in-house VRP-TW solver using static maps and telemetry.

**Pros**
- Full control of logic and data residency.  

**Cons**
- Ignores dynamic traffic, weather, or demand variation.  
- Poor adaptability in live operations.

---


### Option C â€” Context-Aware Internal Solver (Recommended)
Integrate a **VRP-TW solver** with **regional transport adapters**, **weather inputs**, and **demand forecasts**.

**Pros**
- Region-local accuracy and compliance.
- Adaptive routing under real-world conditions.
- Compatible with MobilityCorpâ€™s event-driven backend (ADR-007) and reliability patterns (ADR-001).

**Cons**
- Higher integration complexity.
- Requires feature engineering and model retraining for ETA calibration.

---


## Decision

We will adopt **Option C â€“ Context-Aware Internal VRP-TW Solver** for MobilityCorpâ€™s routing optimization, leveraging regional adapters, live context, and robust auditability. This approach aligns with the platformâ€™s commitment to operational excellence, compliance, and architectural consistency across domains.


**Rationale:**
- Context-aware, region-specific routing is essential for accurate, compliant, and cost-effective field operations across Europe.
- Integration with demand prediction ([ADR-004](./004.md)), weather, and transport feeds enables proactive, adaptive routing under real-world conditions.
- The event-driven, reliable integration pattern ([ADR-001](./001.md)) ensures robust, auditable, and observable routing workflows, supporting SLA measurement and compliance.
- While this approach introduces integration and maintenance complexity, the benefits in adaptability, compliance, and operational efficiency outweigh the trade-offs for a multi-region mobility platform.

Options A and B were rejected because they do not provide sufficient control, compliance, or adaptability to local and real-time context. Option A (external API) risks data residency and cost unpredictability, while Option B (static internal solver) cannot respond to dynamic operational needs.

**Key decisions:**
1. **Transport Adapter Layer:** Normalises regional feeds (GTFS-RT or proprietary) into a unified event schema (`route_id`, `delay`, `region_code`).
2. **Weather Feed Integration:** Weight travel times by live precipitation, temperature, and wind factors.
3. **Demand Prediction Link:** Solver subscribes to `demand.predictions` topic ([ADR-004](./004.md)) to prioritise hubs with projected shortages.
4. **Kafka Topics:**
   - Inputs â†’ `routing.requests`, `transport.status`, `weather.conditions`, `demand.predictions`.
   - Outputs â†’ `routing.solved`, `routing.metrics`.
5. **Solver Engine:** OR-Tools or custom heuristic supporting multi-depot, capacity, and time-window constraints.
6. **Audit & Metrics:** Every solve logged (inputs + hash) to [ADR-011](./011.md) and metrics exported via [ADR-013](./013.md).

---


## Consequences

**Positive Consequences:**
- Region- and weather-aware routing with proactive demand balancing, improving SLA adherence and operational efficiency.
- Reduced missed appointments and travel time, supporting customer satisfaction and cost control.
- Auditable, EU-resident optimisation workflow, supporting compliance and regulatory requirements.

**Negative Consequences / Trade-offs:**
- Higher engineering and data-integration overhead, including ongoing maintenance of provider connectors and model tuning.
- Increased operational complexity in monitoring, schema governance, and event orchestration.

**Stakeholders:**
- Platform Engineering: responsible for solver development, integration, and maintenance.
- Data Engineering: responsible for transport, weather, and demand data pipelines.
- Operations: define business requirements, validate routing outcomes, and monitor SLA adherence.
- Compliance and Legal: oversee data residency, audit, and regulatory requirements.

**Reliability and Integration:**
- All routing requests, context feeds, and solver outputs must use reliable, idempotent delivery patterns as established in [ADR-001](./001.md) (e.g., Outbox + Worker Queue for Kafka topics).
- Downstream consumers must be able to handle retries, late or missing events, and ensure at-least-once processing semantics.

**Audit and Compliance:**
- All routing decisions, inputs, and outcomes must be logged to the Immutable Audit Log ([ADR-011](./011.md)) and be accessible for compliance review.
- Regular audits and SLA reviews must be scheduled and owned by Platform Engineering and Compliance teams. Audit frequency: quarterly, or after any major incident. Compliance team is responsible for regulatory monitoring and escalation.

**Risk Ownership:**
- Platform Engineering is responsible for monitoring solver performance, schema drift, and integration health.
- Compliance team is responsible for data residency, audit, and regulatory risks. Escalation path: incident review â†’ compliance lead â†’ executive sponsor.

**Implementation and Rollout Plan:**
1. Develop and document canonical event schemas for all routing-related topics.
2. Build and validate regional transport adapters and weather collectors.
3. Integrate demand prediction ([ADR-004](./004.md)) and ensure reliable event delivery.
4. Register all solver versions and log all solve events to the Audit Log ([ADR-011](./011.md)).
5. Establish monitoring dashboards and alerting for solver health, latency, and event delivery failures.
6. Communicate rollout plan, milestones, and responsibilities to all stakeholders via regular project updates and review meetings.

**Follow-ups / Open Issues:**
- Finalize event schemas and data contracts with all consuming and producing services.
- Define SLAs for routing latency, reliability, and auditability.
- Review and update compliance documentation as regulations evolve.
- Confirm stakeholder sign-off at each rollout milestone.
- Track open integration issues with regional data providers and update risk register as needed.

---


## Implementation Details (High-level)

| Component | Responsibility | Notes |
|---|---|---|
| **Transport Adapter** | Normalise regional transport feeds | Connectors per country; publishes to Kafka |
| **Weather Collector** | Fetch and broadcast weather data | Hourly updates from OpenWeatherMap / MeteoGroup |
| **Demand Predictor (ADR-004)** | Publish demand forecast events | Feeds solver for hub prioritisation |
| **Routing Solver** | Compute optimal VRP-TW routes | Context-aware heuristics |
| **Kafka Event Bus** | Carry input/output events | EU-resident cluster |
| **Databricks Lakehouse** | Persist solved routes & metrics | For analytics and retraining |
| **Audit Log (ADR-011)** | Immutable route decision record | Hash-chained ledger |
| **Observability (ADR-013)** | Track latency, success rate, solver cost | OTel metrics |

**Sequence Example**

<img width="4008" height="1170" alt="005" src="https://github.com/user-attachments/assets/c4998f7e-42ff-4d67-8006-f8e8fab7f7ee" />

---


## Risks and Mitigations

| Risk                           | Likelihood | Impact | Mitigation                            |
| ------------------------------ | ---------: | -----: | ------------------------------------- |
| Provider API schema drift      |        Med |   High | Schema registry + contract tests      |
| Weather API latency            |        Low |    Med | Cache & extrapolate short gaps        |
| Incorrect demand bias          |        Med |    Med | Periodic model validation             |
| Region data inconsistency      |        Med |    Med | Region-code governance & monitoring   |
| Solver performance degradation |        Med |    Med | Heuristic tuning & parallel execution |


## Alternatives Considered

- **Third-party API only** â€“ rejected for cost, lack of control, and compliance risks.
- **Static internal solver** â€“ rejected for lack of context awareness and adaptability.
- **Context-aware solver** â€“ chosen for adaptability, compliance, and alignment with MobilityCorpâ€™s governance and integration standards.


## Related ADRs

- [ADR-001 â€“ External Dependency SLA & Retry Handling](./001.md)
- [ADR-002 â€“ Pricing & Billing Microservice Architecture](./002.md)
- [ADR-004 â€“ Demand Prediction Model](./004.md)
- [ADR-007 â€“ Data Platform Architecture](./007.md)
- [ADR-011 â€“ Immutable Audit Log Architecture](./011.md)
- [ADR-013 â€“ Observability & Metrics Standardisation](./013.md)
- [ADR-016 â€“ AI Data Pipeline & Feature Store Design](./016.md)
- [ADR-018 â€“ AI Cost & Budget Guardrails](./018.md)