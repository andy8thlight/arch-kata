---
id: "0003"
title: Geofence & Fine Enforcement Logic
status: proposed
date: 2025-10-18
---

## Context and Problem Statement

MobilityCorp operates with **designated hubs**. Riders must **end rides inside a valid hub geofence**; otherwise **per-minute fines** apply after a configurable grace period. We must:

- Enforce hub geofences **consistently across cities**.
- Avoid **false positives** due to GPS jitter/urban canyons.
- Provide **tamper-evident evidence** for fines and support **dispute workflows**.
- Keep rules **configurable** (pricing, grace, caps, exceptions) and **auditable**.
- Integrate with **external IoT** (position/lock state via provider), **Billing** (charges), **Policy-as-Data** (rates/rules), and **Audit Log** (proof).

Key questions:
- Where do the **geofence rules** and **fine parameters** live (code vs data)?
- How do we **detect** out-of-hub end-ride robustly (jitter, stale telemetry)?
- What **evidence** must be recorded for fair and GDPR-compliant disputes?
- How do we **cap** or **suspend** fines (e.g., accessibility exceptions, force majeure)?
- How does this interact with **destination-based flow** and **hub-slot reservations**?

## Options

### Option A — Hard-code geofence & fine rules in app/backends
Implement geofence checks and fine calculation inside Ride/Billing services.

**Pros**
- Lower initial complexity.
- Fewer moving parts.

**Cons**
- Rule changes require deployments; city variants are brittle.
- High coupling; hard to audit which rules applied when.
- Harder to simulate/test policy changes safely.

---

### Option B — **Policy-as-Data + Event-Driven Enforcement**
Store rules (geofence shapes, grace periods, per-minute rates, caps, exception lists) in a **Policy Service** (ADR-019).  
Ride Service emits **ride_end_proposed** with telemetry + context; a **Geofence/Fines engine** evaluates policy and emits **fine_assessed** events consumed by Billing (ADR-002). Evidence + decisions are written to the **Immutable Audit Log** (ADR-011).

**Pros**
- Central, versioned, auditable rules; city/campaign overrides.
- Safer experimentation and A/B (no redeploys).
- Clear evidence package for disputes.
- Decouples detection (Ride) from enforcement (Policy/Billing).

**Cons**
- Adds an extra service hop and eventual consistency.
- Requires robust schema/version governance.

---

### Option C — Manual back-office enforcement only
Operators review out-of-hub sessions and apply fines case-by-case.

**Pros**
- Human judgment for edge cases.

**Cons**
- Not scalable; inconsistent outcomes; delays revenue recognition.

---

### Option D — Device-side hard enforcement (lock refuses end outside hub)
Leverage IoT to block “end ride” until inside geofence.

**Pros**
- Prevents fines entirely by preventing violations.

**Cons**
- Harsh UX (no graceful end if hub is full/blocked).
- We don’t control device firmware (IoT external); limited feasibility.
- Edge cases (low battery, safety) still need server-side logic.

## Decision

## Consequences
