---
id: "0003"
title: Geofence & Fine Enforcement Logic
status: proposed
date: 2025-10-18
---

## Context and Problem Statement

MobilityCorp operates with **designated hubs**. Riders must **end rides inside a valid hub geofence**; otherwise **per-minute fines** apply after a configurable grace period. We must:

- Enforce hub geofences **consistently across cities**.
- Avoid **false positives** due to GPS jitter/urban canyons.
- Provide **tamper-evident evidence** for fines and support **dispute workflows**.
- Keep rules **configurable** (pricing, grace, caps, exceptions) and **auditable**.
- Integrate with **external IoT** (position/lock state via provider), **Billing** (charges), **Policy-as-Data** (rates/rules), and **Audit Log** (proof).

Key questions:
- Where do the **geofence rules** and **fine parameters** live (code vs data)?
- How do we **detect** out-of-hub end-ride robustly (jitter, stale telemetry)?
- What **evidence** must be recorded for fair and GDPR-compliant disputes?
- How do we **cap** or **suspend** fines (e.g., accessibility exceptions, force majeure)?
- How does this interact with **destination-based flow** and **hub-slot reservations**?

## Options

### Option A — Hard-code geofence & fine rules in app/backends
Implement geofence checks and fine calculation inside Ride/Billing services.

**Pros**
- Lower initial complexity.
- Fewer moving parts.

**Cons**
- Rule changes require deployments; city variants are brittle.
- High coupling; hard to audit which rules applied when.
- Harder to simulate/test policy changes safely.

---

### Option B — **Policy-as-Data + Event-Driven Enforcement**
Store rules (geofence shapes, grace periods, per-minute rates, caps, exception lists) in a **Policy Service** (ADR-019).  
Ride Service emits **ride_end_proposed** with telemetry + context; a **Geofence/Fines engine** evaluates policy and emits **fine_assessed** events consumed by Billing (ADR-002). Evidence + decisions are written to the **Immutable Audit Log** (ADR-011).

**Pros**
- Central, versioned, auditable rules; city/campaign overrides.
- Safer experimentation and A/B (no redeploys).
- Clear evidence package for disputes.
- Decouples detection (Ride) from enforcement (Policy/Billing).

**Cons**
- Adds an extra service hop and eventual consistency.
- Requires robust schema/version governance.

---

### Option C — Manual back-office enforcement only
Operators review out-of-hub sessions and apply fines case-by-case.

**Pros**
- Human judgment for edge cases.

**Cons**
- Not scalable; inconsistent outcomes; delays revenue recognition.

---

### Option D — Device-side hard enforcement (lock refuses end outside hub)
Leverage IoT to block “end ride” until inside geofence.

**Pros**
- Prevents fines entirely by preventing violations.

**Cons**
- Harsh UX (no graceful end if hub is full/blocked).
- We don’t control device firmware (IoT external); limited feasibility.
- Edge cases (low battery, safety) still need server-side logic.

## Decision

We will adopt **Option B — Policy-as-Data + Event-Driven Enforcement** for geofence and fine enforcement logic.

**Rationale:**
- Centralizing geofence and fine rules as data (not code) enables rapid, auditable, and city-specific policy changes without redeployments, supporting regulatory and operational agility.
- The event-driven approach decouples detection (Ride Service) from enforcement (Policy/Billing), allowing for robust, versioned, and tamper-evident evidence trails (see ADR-011 for audit log integration).
- This pattern aligns with the reliability, idempotency, and reconciliation strategies established in ADR-001 and ADR-002, ensuring fines and charges are processed consistently and can be reconciled with billing and payment records.
- Enables safer experimentation (A/B testing, campaign overrides) and supports dispute workflows with clear evidence packages.
- While it introduces some complexity and eventual consistency, these are outweighed by the benefits in correctness, auditability, and maintainability for a multi-city, regulated mobility platform.

Options A and D were rejected due to inflexibility, high coupling, and lack of auditability. Option C was rejected due to lack of scalability and inconsistent outcomes.
## Consequences

**Positive Consequences:**
- Geofence and fine rules are centrally managed, versioned, and auditable, supporting city/campaign overrides and regulatory compliance.
- Decoupled, event-driven flow enables robust evidence collection and tamper-evident audit trails for all enforcement actions (see ADR-011).
- Supports rapid policy changes, safer experimentation, and clear dispute resolution processes.
- Integrates cleanly with Billing (ADR-002) and external IoT providers, leveraging the Outbox + Worker Queue pattern for reliable event delivery (ADR-001).

**Negative Consequences:**
- Adds service hops and eventual consistency, which may introduce delays in fine assessment and user notification.
- Requires robust schema/version governance and operational monitoring across services.
- Increased complexity in event orchestration and evidence management.

**Risks and Mitigations:**
- Risk: Policy or event schema changes could break enforcement or auditability. Mitigation: Strict versioning, automated tests, and backward compatibility for policy and event schemas.
- Risk: Event delivery failures could result in missed or duplicate fines. Mitigation: Use Outbox + Worker Queue pattern (ADR-001) and idempotency keys for all enforcement events.
- Risk: GPS inaccuracies or IoT data gaps could lead to false positives/negatives. Mitigation: Implement grace periods, evidence bundling, and manual override workflows for edge cases.

**Stakeholders:**
- Product, Policy, Engineering, Customer Support, and Legal/Compliance teams must be involved in rule definition, enforcement, dispute handling, and audit processes.

**Implementation Notes / Follow-ups:**
- Define canonical event schemas for `ride_end_proposed`, `fine_assessed`, and evidence packages.
- Integrate with Policy Service (ADR-019), Billing (ADR-002), and Immutable Audit Log (ADR-011).
- Ensure all enforcement and billing events use reliable, idempotent delivery patterns (ADR-001).
- Establish monitoring and alerting for enforcement pipeline health and SLA breaches.
- Document dispute and override workflows for accessibility, force majeure, and edge cases.
