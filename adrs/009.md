---
id: "0009"
title: Personalisation / Concierge Service Architecture
status: proposed
date: 2025-10-21
---

## Context and Problem Statement

MobilityCorp intends to build a **Personalisation and Concierge Service** to deliver context-aware, opt-in recommendations —  
such as preferred routes, vehicle assignments, or scheduling suggestions — based on past user behaviour and service patterns.

The service must:

- Operate within **GDPR** and EU-residency requirements.  
- Segregate identifiable user data from aggregated analytical data.  
- Support explainable and auditable AI behaviour.  
- Provide a foundation for **future contextual and semantic reasoning** (e.g., similar journeys, preference-based clustering).

The key challenge is to enable personalised, AI-assisted experiences without compromising **privacy, compliance, or transparency**.

---

## Questions

- Should recommendations rely solely on deterministic models or allow contextual retrieval?  
- How should user data and embeddings be separated to maintain GDPR compliance?  
- What form of AI inference is most appropriate for the MVP?  
- Should the system support **semantic similarity search** (vector retrieval) from launch?  
- How can explainability and traceability be guaranteed across AI recommendations?  

---

## Options

### Option A — Warehouse-Only Recommendations
Use Databricks (EU warehouse) for all model training and inference, returning pre-computed personalised outputs.

**Pros**
- Simpler architecture; minimal new components.  
- Strong governance and lineage within existing data platform.  

**Cons**
- No real-time or contextual personalisation.  
- Cannot support semantic or similarity-based reasoning.  

---

### Option B — Real-Time Model Training
Continuously train or fine-tune user-specific models for each profile or segment.

**Pros**
- Highly accurate, adaptive recommendations.  
- Learns evolving user preferences quickly.  

**Cons**
- High compute and storage cost.  
- Potential GDPR and consent complications.  
- Operationally complex to maintain per-user models.  

---

### Option C — Hybrid with Optional Vector Database (Recommended)
Combine warehouse-based training with an **optional vector retrieval layer** to enhance inference with contextual and semantic memory.

- Store **embeddings** of historical user interactions, trip summaries, and preferences.  
- Query the **vector DB** for similar journeys or users at inference time.  
- Maintain strict separation between PII and vector data through pseudonymisation and encryption.  

**Pros**
- Enables semantic and contextual reasoning (RAG-style).  
- Scales gradually; optional for MVP.  
- Supports explainability by referencing similar examples.  
- Maintains compliance boundaries.  

**Cons**
- Additional infrastructure (embedding jobs, vector store).  
- Requires ongoing governance of embedding data lifecycle.  

---

## Recommendation

Adopt **Option C – Hybrid with Optional Vector Database (RAG-style Retrieval)**.

- Implement a **segregated Personalisation Service** consuming event-driven data from Kafka and aggregated features from Databricks.  
- Integrate an **optional Vector Database** (e.g., Weaviate, Pinecone, or Databricks Vector Search) as a **semantic retrieval layer**.  
- Provide a **Personalisation API** for downstream clients (mobile/web) that can query both model outputs and contextual vectors.  
- Ensure **user consent gating** and **pseudonymised embeddings** for GDPR compliance.  
- Support explainability by surfacing similar historical journeys or profiles during inference.

---

## Consequences

**Positive**
- Extensible AI architecture; supports both deterministic and contextual reasoning.  
- Enables future semantic search, explainability, and clustering use cases.  
- Preserves privacy and governance through segregation of data layers.  

**Trade-offs**
- Slightly higher infra and governance overhead if vector layer activated.  
- Requires embedding generation and periodic refresh.  
- Additional observability and versioning required for retrieval layer.  

---

## Implementation Details (High-level)

| Component | Responsibility | Notes |
|---|---|---|
| **Kafka / Event Bus** | Stream user and trip events | Standard event schema; GDPR pseudonymisation upstream |
| **Databricks Warehouse** | Aggregate data, train models, manage features | EU-resident; primary analytical store |
| **Vector Database (optional)** | Store embeddings of journeys, preferences, feedback | Used for similarity and contextual retrieval |
| **Personalisation API** | Runtime inference and recommendation delivery | Combines model output + vector lookup |
| **Consent & Privacy Layer** | Gating and token-based access for opted-in users | Ensures compliance and transparency |
| **Mobile / Concierge App** | Display personalised insights and collect feedback | Sends feedback events to Kafka |

**Sequence Example**
```mermaid
sequenceDiagram
    title Personalisation / Concierge Flow with Optional Vector Retrieval

    participant APP as Mobile / Concierge App
    participant API as Personalisation API
    participant VDB as Vector DB (Optional)
    participant DWH as Databricks (EU Warehouse)
    participant BUS as Event Bus (Kafka)

    APP->>BUS: Emit user events (journeys, preferences)
    BUS-->>DWH: Stream to warehouse for aggregation
    DWH-->>API: Provide model outputs and features
    Note over API,VDB: Optional semantic context
    API->>VDB: Query for similar journeys / users
    VDB-->>API: Return contextual embeddings
    API-->>APP: Serve personalised recommendation
    APP->>BUS: Send feedback for retraining loop

----

## Risks and Mitigations

| Risk                                   | Likelihood | Impact | Mitigation                                        |
| -------------------------------------- | ---------: | -----: | ------------------------------------------------- |
| Misuse of embeddings containing PII    |        Low |   High | Pseudonymisation; separate encryption domain      |
| Vector store cost / latency            |        Med |    Med | Activate only for contextual AI services          |
| Model drift or inconsistent embeddings |        Med |    Med | Periodic retraining and embedding refresh         |
| Consent withdrawal handling            |        Low |   High | Hard-delete vectors linked to user ID             |
| Over-personalisation (user discomfort) |        Low |    Med | Transparency UI; configurable preference settings |

---

## Alternatives Considered

* Warehouse-only pipeline – simple but static; rejected for lack of contextual depth.
* Per-user models – highly adaptive but costly and non-compliant; rejected.
* Hybrid with vector retrieval – chosen for balance of extensibility, compliance, and explainability.

## Links

* ADR-005 – Routing Solver (VRP-TW)
* ADR-007 – Data Platform Architecture
* ADR-008 – Mobile Offline Sync Strategy
* ADR-013 – Immutable Audit Log Architecture
* ADR-016 – AI Interchange Layer
