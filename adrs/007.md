---
id: "007"
title: Data Platform Architecture
status: proposed
date: 2025-10-18
---

## Context and Problem Statement

MobilityCorp’s next-gen platform requires a **unified, EU-resident data platform** to support:
- **Real-time operations** (routing, alerts, hub capacity)
- **Analytics & reporting** (city KPIs, finance, compliance)
- **ML/AI** (forecasting, anomaly detection, personalisation)
- **Auditability** (GDPR, financial traceability)

Key constraints:
- **EU-only** data residency and GDPR compliance
- Multiple producers (IoT telemetry, product services, payments, IDV, external feeds)
- Need for both **streaming** (seconds/minutes) and **batch** (hourly/daily) processing
- Clear **PII boundaries, retention, lineage, and explainability** across models

### Questions
- Event bus as **system backbone** vs. point-to-point integrations?
- Lake vs. warehouse vs. **lakehouse** for cost, flexibility, and governance?
- How to enforce **schema contracts**, **consent/PII controls**, and **lineage**?
- How to serve **low-latency features** to models and **BI-friendly** curated data to analysts?

---

## Options

### Option A — Warehouse-centric (ELT to cloud DWH)
All sources ETL/ELT into a central warehouse; limited streaming.

**Pros:**
- Strong SQL/BI ergonomics
- Mature governance in-warehouse  

**Cons:** 
- Weak for high-throughput streaming/IoT
- Expensive for raw landing
- Limited data science flexibility

---

### Option B — Data Lake + ad hoc streams
Dump raw into object storage; ad hoc ingestion consumers; separate BI loaders.

**Pros:** 
- Cheap storage
- flexible formats  
**Cons:**
- Governance gaps (schema drift, lineage)
- Fragmented serving paths
- High ops burden

---

### Option C — **Lakehouse + Event Bus (Recommended)**
Use a **durable event bus** for ingestion + a **transactional lakehouse** (e.g., Iceberg/Delta/Hudi) for unified batch/stream storage; expose **curated marts** to DWH/BI and **features** to ML.

**Pros:**
- Handles streaming + batch
- Open table formats
- Scalable & cost-efficient
- Clear medallion layering  
**Cons:** 
- More initial platform work (catalog, schema registry, ACLs)
- Requires data engineering maturity

---

## Decision

Adopt **Option C: Event-Driven Ingestion + Lakehouse**.

- **Event Bus** (Kafka or equivalent) is the **ingestion backbone** for operational events (rides, telemetry, billing, alerts).
- Persist to an **EU-resident lakehouse** (open table format: Iceberg/Delta/Hudi) with **Bronze/Silver/Gold** layers:
  - **Bronze**: raw, immutable, partitioned; PII tagged
  - **Silver**: cleaned, conformed, de-duplicated; privacy transformations applied
  - **Gold**: business-ready marts for BI and finance; policy versioned
- A **Feature Store (ADR-0018)** serves online/offline features to AI Interchange (ADR-0016).
- A **Data Catalog + Lineage** system tracks schemas, owners, lineage, and usage.
- **Schema Registry** enforces contracts for event producers/consumers.
- **GDPR controls** (consent flags, PII tokenisation, retention policies) enforced at ingest and transformation boundaries.

---

## Consequences

**Positive**
- Single, governed source for analytics, ML, and audit; scalable streaming and batch  
- Open formats reduce vendor lock-in; EU residency by design  
- Clear privacy boundaries and repeatable transformations (time travel, reproducibility)

**Trade-offs**
- Higher initial platform setup (governance, tooling, processes)  
- Requires producer discipline (schema evolution, idempotency)  
- Dual-mode ops (stream + batch) to run reliably

---

## Implementation Details (High-level)

### Core Components
| Component | Responsibility |
|---|---|
| **Event Bus (Kafka or equiv.)** | Ingest operational events; topics per domain; compacted/state topics where needed |
| **Schema Registry** | Versioned schemas (Avro/JSON/Protobuf); compatibility rules; producer validation |
| **Lakehouse Storage** | Bronze/Silver/Gold tables; ACID; time travel; EU region buckets |
| **Stream Processing** | Real-time ETL/enrichment (Flink/Spark/KStreams) from Bronze → Silver |
| **Batch Processing** | Scheduled jobs (dbt/Spark) from Silver → Gold marts |
| **Feature Store (ADR-0018)** | Online/offline features; point-in-time correctness |
| **Catalog & Lineage** | Data discovery, ownership, lineage (e.g., DataHub/OpenMetadata) |
| **Access Control** | RBAC/ABAC, row/column-level security for PII; consent gates |
| **Audit & Observability** | Data quality checks, freshness SLAs, pipeline metrics; immutable audit (ADR-0013) |

### Domains / Topics (examples)
- `telemetry.vehicle.v1` (GPS, battery, lock, tilt)  
- `ride.lifecycle.v1` (start, end, pause, resume)  
- `billing.ledger.v1` (preauth, capture, refund, fine)  
- `policy.version.v1` (pricing/fine rules)  
- `alerts.anomaly.v1` (theft/tamper signals)  
- `ops.routing.v1` (route_plan.created/updated)  
- `external.weather.v1`, `external.events.v1`

### Privacy & GDPR
- **PII minimisation:** user identifiers tokenised at source; personalisation is opt-in only  
- **Consent enforcement:** consent status carried as attribute; dropped or anonymised if revoked  
- **Retention:** configurable retention per table/category (e.g., raw 90d, silver 24m, aggregates 7y)  
- **DSR support:** lookups by tokenised subject; deletion workflows cascade through lakehouse (vacuum) and features

---

## Mermaid — Logical Data Flow

```mermaid
flowchart LR
  subgraph Producers
    SVC[Product Services]\n(Ride, Billing, Policy)
    IOT[IoT Telemetry]
    EXT[External Feeds]\n(Weather, Events, Maps)
  end

  BUS[(Event Bus)]
  REG[[Schema Registry]]

  subgraph Lakehouse (EU)
    BRZ[Bronze: Raw Immutable]
    SLV[Silver: Cleaned/Conformed]
    GLD[Gold: Curated Marts]
  end

  subgraph Processing
    STR[Stream ETL/Enrichment]
    BAT[Batch Transform (dbt/Spark)]
    FEAT[Feature Store]
  end

  subgraph Consumers
    ROUTE[Routing Service\n(ADR-0005)]
    ALERTS[Alerts/Theft\n(ADR-0006)]
    FORE[Forecasting Service\n(ADR-0004)]
    BILL[Finance/BI/Reports]
    BO[Back Office Dashboards]
    AIINT[AI Interchange\n(ADR-0016)]
  end

  SVC -->|events| BUS
  IOT -->|telemetry| BUS
  EXT -->|events| BUS
  BUS --> REG
  BUS --> BRZ
  BRZ --> STR --> SLV
  SLV --> BAT --> GLD
  SLV --> FEAT
  FEAT --> AIINT
  GLD --> BILL
  GLD --> BO
  SLV --> FORE
  SLV --> ROUTE
  SLV --> ALERTS

---

### Risks and Mitigations

| Risk                            | Likelihood | Impact | Mitigation                                                                         |
| ------------------------------- | ---------: | -----: | ---------------------------------------------------------------------------------- |
| Schema drift from producers     |        Med |    Med | Schema Registry with compat rules; contract testing; quarantine bad messages       |
| Event loss / duplication        |    Low–Med |    Med | Idempotent keys; at-least-once; DLQs; reconciliation jobs (ADR-0002)               |
| GDPR violations (PII leakage)   |        Low |   High | PII tagging; column-level ACLs; tokenisation; consent gates; audits                |
| Cost overrun in storage/compute |        Med |    Med | Tiered retention; compaction; autoscaling; cost dashboards (ADR-0020)              |
| Latency spikes impacting ops    |        Med |    Med | Priority lanes for operational topics; backpressure controls; SLO alerts           |
| Vendor lock-in                  |    Low–Med |    Med | Open formats (Iceberg/Delta/Hudi); portable compute engines; EU region portability |
| Data quality regressions        |        Med |    Med | Great Expectations/dbt tests; freshness checks; fail-closed policies               |


### Alternatives Considered

* Warehouse-only: simple but weak for streaming IoT and ML feature reuse
* Lake-only: flexible but governance-poor and BI-unfriendly
* Point-to-point service integrations: brittle; hard to audit and evolve

### Links

* ADR-0002 – External Dependency SLA & Retry Handling
* ADR-0003 – Pricing & Billing Microservice Architecture
* ADR-0004 – Demand Prediction Model Design
* ADR-0005 – Routing Solver (VRP-TW)
* ADR-0006 – Alerts & Theft Detection Logic
* ADR-0013 – Immutable Audit Log Architecture
* ADR-0016 – AI Interchange Layer
* ADR-0018 – AI Data Pipeline & Feature Store Design
* ADR-0019 – AI Governance & Explainability
* ADR-0020 – AI Cost & Budget Guardrails